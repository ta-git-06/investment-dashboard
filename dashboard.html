<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æŠ•è³‡ãƒ¢ãƒ‹ã‚¿ãƒ¼</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='8' fill='%232563eb'/%3E%3Cpolyline points='3,24 9,14 14,18 22,8 29,12' stroke='white' stroke-width='3.5' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', sans-serif; }
    .bg-fear-extreme  { background: #fff1f1; border-left: 4px solid #ef4444; }
    .bg-fear          { background: #fff7ed; border-left: 4px solid #f97316; }
    .bg-neutral       { background: #fefce8; border-left: 4px solid #eab308; }
    .bg-greed         { background: #f0fdf4; border-left: 4px solid #84cc16; }
    .bg-greed-extreme { background: #dcfce7; border-left: 4px solid #22c55e; }
    .card { background: #ffffff; border-radius: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.07), 0 4px 16px rgba(0,0,0,0.05); }
    .chart-wrap { position: relative; height: 220px; }
    .chart-tall  { position: relative; height: 280px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="border-b border-slate-200 px-4 py-4 sticky top-0 bg-white z-10 shadow-sm">
    <div class="max-w-5xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-2">
        <!-- ãƒ­ã‚´ã‚¢ã‚¤ã‚³ãƒ³ -->
        <div class="w-7 h-7 rounded-lg bg-blue-600 flex items-center justify-center">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <polyline points="1,12 5,7 8,9 12,4 15,6" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
          </svg>
        </div>
        <h1 class="text-base font-bold tracking-tight text-slate-800">æŠ•è³‡ãƒ¢ãƒ‹ã‚¿ãƒ¼</h1>
      </div>
      <span id="lastUpdated" class="text-slate-400 text-xs">èª­ã¿è¾¼ã¿ä¸­â€¦</span>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading" class="text-center text-slate-400 py-20">
      <div class="text-4xl mb-3">â³</div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ -->
    <div id="error" class="hidden text-center py-20">
      <div class="text-4xl mb-3">âš ï¸</div>
      <p class="text-red-500" id="errorMsg"></p>
      <p class="text-slate-400 text-sm mt-2">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹äººã¯é–²è¦§å¯èƒ½ã€ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div id="content" class="hidden space-y-6">

      <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
      <section>
        <p class="text-xs text-slate-400 uppercase tracking-widest mb-3">æœ€æ–°ãƒ‡ãƒ¼ã‚¿</p>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">

          <!-- F&G ã‚«ãƒ¼ãƒ‰ -->
          <div id="card-fg" class="rounded-2xl p-4 bg-neutral">
            <p class="text-xs text-slate-500 mb-1">Fear &amp; Greed</p>
            <p id="fg-score" class="text-4xl font-black">â€”</p>
            <p id="fg-label" class="text-xs mt-1 text-slate-600">â€”</p>
            <p id="fg-change" class="text-xs text-slate-400 mt-1">å‰æ—¥æ¯” â€”</p>
          </div>

          <!-- SKEW ã‚«ãƒ¼ãƒ‰ -->
          <div class="card p-4">
            <p class="text-xs text-slate-400 mb-1">SKEW Index</p>
            <p id="skew-score" class="text-4xl font-black text-cyan-500">â€”</p>
            <p id="skew-label" class="text-xs mt-1 text-slate-500">â€”</p>
          </div>

          <!-- S&P500 ã‚«ãƒ¼ãƒ‰ -->
          <div class="card p-4">
            <p class="text-xs text-slate-400 mb-1">S&amp;P500</p>
            <p id="sp500-price" class="text-2xl font-black text-blue-600">â€”</p>
          </div>

          <!-- NASDAQ ã‚«ãƒ¼ãƒ‰ -->
          <div class="card p-4">
            <p class="text-xs text-slate-400 mb-1">NASDAQ</p>
            <p id="nasdaq-price" class="text-2xl font-black text-emerald-600">â€”</p>
          </div>

        </div>
      </section>

      <!-- F&G æ¨ç§»ã‚°ãƒ©ãƒ• -->
      <section class="card p-4">
        <p class="text-sm font-semibold text-slate-700 mb-4">Fear &amp; Greed Index æ¨ç§»</p>
        <div class="chart-wrap"><canvas id="fgChart"></canvas></div>
      </section>

      <!-- å¸‚å ´ä¾¡æ ¼ã‚°ãƒ©ãƒ• -->
      <section class="card p-4">
        <p class="text-sm font-semibold text-slate-700 mb-4">S&amp;P500 / NASDAQ æ¨ç§»</p>
        <div class="chart-wrap"><canvas id="marketChart"></canvas></div>
      </section>

      <!-- åˆä½“ã‚°ãƒ©ãƒ•ï¼šS&P500 / NASDAQ / F&G -->
      <section class="card p-4">
        <p class="text-sm font-semibold text-slate-700 mb-1">S&amp;P500 / NASDAQ / Fear &amp; Greed æ¨ç§»</p>
        <p class="text-xs text-slate-400 mb-4">å·¦è»¸ï¼šS&amp;P500ã€€å³è»¸ï¼šNASDAQã€€ã‚ªãƒ¬ãƒ³ã‚¸ãƒ©ã‚¤ãƒ³ï¼šFear &amp; Greedï¼ˆ0ã€œ100ï¼‰</p>
        <div class="chart-tall"><canvas id="combinedChart"></canvas></div>
      </section>

      <!-- ç›´è¿‘ãƒ†ãƒ¼ãƒ–ãƒ« -->
      <section class="card p-4">
        <p class="text-sm font-semibold text-slate-700 mb-4">ç›´è¿‘ã®è¨˜éŒ²</p>
        <div class="overflow-x-auto">
          <table class="w-full text-xs">
            <thead>
              <tr class="border-b border-slate-100 text-slate-400 text-left">
                <th class="pb-2 pr-3 font-medium whitespace-nowrap">æ—¥ä»˜</th>
                <th class="pb-2 pr-3 font-medium text-right whitespace-nowrap">F&amp;G</th>
                <th class="pb-2 pr-3 font-medium whitespace-nowrap">çŠ¶æ…‹</th>
                <th class="pb-2 pr-3 font-medium text-right whitespace-nowrap">SKEW</th>
                <th class="pb-2 pr-3 font-medium text-right whitespace-nowrap">S&amp;P500</th>
                <th class="pb-2 pr-3 font-medium text-right whitespace-nowrap">SP500 10ä¸‡å††â†’</th>
                <th class="pb-2 pr-3 font-medium text-right whitespace-nowrap">SP500 æç›Š</th>
                <th class="pb-2 pr-3 font-medium text-right whitespace-nowrap">NASDAQ</th>
                <th class="pb-2 pr-3 font-medium text-right whitespace-nowrap">NDQ 10ä¸‡å††â†’</th>
                <th class="pb-2 font-medium text-right whitespace-nowrap">NDQ æç›Š</th>
              </tr>
            </thead>
            <tbody id="tableBody" class="text-slate-600"></tbody>
          </table>
        </div>
      </section>

      <!-- æ¥µåº¦ã®ææ€–ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç›´è¿‘2å¹´ãƒ»F&G â‰¤ 35ï¼‰ -->
      <section class="card p-4" style="border-left: 4px solid #ef4444;">
        <p class="text-sm font-semibold text-slate-700 mb-1">ğŸ”´ æ¥µåº¦ã®ææ€–ã‚¾ãƒ¼ãƒ³ï¼ˆF&amp;G â‰¤ 35ï¼‰</p>
        <p class="text-xs text-slate-400 mb-4">Fear &amp; GreedãŒ35ä»¥ä¸‹ã ã£ãŸæ—¥ã®å…¨è¨˜éŒ²</p>
        <div class="overflow-x-auto">
          <table class="w-full text-xs">
            <thead>
              <tr class="border-b border-slate-100 text-slate-400 text-left">
                <th class="pb-2 pr-3 font-medium whitespace-nowrap">æ—¥ä»˜</th>
                <th class="pb-2 pr-3 font-medium text-right whitespace-nowrap">F&amp;G</th>
                <th class="pb-2 pr-3 font-medium whitespace-nowrap">çŠ¶æ…‹</th>
                <th class="pb-2 pr-3 font-medium text-right whitespace-nowrap">SKEW</th>
                <th class="pb-2 pr-3 font-medium text-right whitespace-nowrap">S&amp;P500</th>
                <th class="pb-2 pr-3 font-medium text-right whitespace-nowrap">SP500 10ä¸‡å††â†’</th>
                <th class="pb-2 pr-3 font-medium text-right whitespace-nowrap">SP500 æç›Š</th>
                <th class="pb-2 pr-3 font-medium text-right whitespace-nowrap">NASDAQ</th>
                <th class="pb-2 pr-3 font-medium text-right whitespace-nowrap">NDQ 10ä¸‡å††â†’</th>
                <th class="pb-2 font-medium text-right whitespace-nowrap">NDQ æç›Š</th>
              </tr>
            </thead>
            <tbody id="fearTableBody" class="text-slate-600"></tbody>
          </table>
          <p id="fearTableEmpty" class="hidden text-center text-slate-400 py-6 text-xs">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</p>
        </div>
      </section>

    </div>
  </main>

  <script>
    // â”€â”€ è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SPREADSHEET_ID = '1NRXvfUjCaBJEGKvmRajf2LKDT6UOWc7oNgQ3Hb4Dgpc';
    const SHEET_NAME     = 'ãƒ­ã‚°';

    // åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0å§‹ã¾ã‚Šï¼‰
    const C = {
      DATE: 0, FG: 1, LABEL_EN: 2, LABEL_JA: 3, CHANGE: 4,
      SKEW: 5,
      SP500: 6, SP500_INV: 7, SP500_PNL: 8,
      NASDAQ: 9, NASDAQ_INV: 10, NASDAQ_PNL: 11,
      NOTIFY: 12,
    };

    // â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function fgColor(s) {
      if (s <= 24) return '#ef4444';
      if (s <= 44) return '#f97316';
      if (s <= 55) return '#eab308';
      if (s <= 74) return '#84cc16';
      return '#22c55e';
    }
    function fgBg(s) {
      if (s <= 24) return 'bg-fear-extreme';
      if (s <= 44) return 'bg-fear';
      if (s <= 55) return 'bg-neutral';
      if (s <= 74) return 'bg-greed';
      return 'bg-greed-extreme';
    }
    function skewLabel(v) {
      if (v >= 145) return 'âš ï¸ æ¥µã‚ã¦é«˜ã„';
      if (v >= 130) return 'ğŸŸ¡ é«˜ã‚';
      if (v >= 115) return 'ğŸŸ¢ é€šå¸¸ç¯„å›²';
      return 'ğŸ”µ ä½ã‚';
    }
    function pnlClass(str) {
      if (!str || str === 'â€”') return 'text-slate-400';
      return str.startsWith('+') ? 'text-emerald-600' : 'text-red-500';
    }
    function num(v) {
      const n = parseFloat(String(v).replace(/[Â¥,]/g, ''));
      return isNaN(n) ? null : n;
    }
    function fmt(v) {
      const n = num(v);
      return n !== null ? n.toLocaleString('ja-JP') : 'â€”';
    }

    // â”€â”€ CSV ãƒ‘ãƒ¼ã‚µãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function parseCSV(text) {
      return text.split('\n').filter(l => l.trim()).map(line => {
        const row = []; let cur = '', inQ = false;
        for (const ch of line) {
          if (ch === '"') { inQ = !inQ; }
          else if (ch === ',' && !inQ) { row.push(cur.trim()); cur = ''; }
          else cur += ch;
        }
        row.push(cur.trim());
        return row;
      });
    }

    // â”€â”€ ãƒ‡ãƒ¼ã‚¿å–å¾— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadData() {
      const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const rows = parseCSV(await res.text());
      return rows.slice(1).filter(r => r[C.DATE] && r[C.FG]);
    }

    // â”€â”€ ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderSummary(r) {
      const score = num(r[C.FG]) ?? 0;

      // F&G
      const card = document.getElementById('card-fg');
      card.className = `rounded-2xl p-4 ${fgBg(score)}`;
      const scoreEl = document.getElementById('fg-score');
      scoreEl.textContent = Math.round(score);
      scoreEl.style.color = fgColor(score);
      document.getElementById('fg-label').textContent = r[C.LABEL_JA] || 'â€”';
      const ch = num(r[C.CHANGE]);
      document.getElementById('fg-change').textContent =
        ch !== null ? `å‰æ—¥æ¯” ${ch >= 0 ? '+' : ''}${ch.toFixed(2)}` : 'å‰æ—¥æ¯” â€”';

      // SKEW
      const skew = num(r[C.SKEW]);
      document.getElementById('skew-score').textContent = skew !== null ? skew.toFixed(1) : 'â€”';
      document.getElementById('skew-label').textContent = skew !== null ? skewLabel(skew) : 'â€”';

      // S&P500
      document.getElementById('sp500-price').textContent = fmt(r[C.SP500]);

      // NASDAQ
      document.getElementById('nasdaq-price').textContent = fmt(r[C.NASDAQ]);

      // æœ€çµ‚æ›´æ–°
      document.getElementById('lastUpdated').textContent = `æœ€çµ‚æ›´æ–°: ${r[C.DATE]}`;
    }

    // â”€â”€ F&G ã‚°ãƒ©ãƒ• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderFGChart(rows) {
      const labels = rows.map(r => r[C.DATE].split(' ')[0]);
      const scores = rows.map(r => num(r[C.FG]));
      const colors = scores.map(s => fgColor(s ?? 50));

      new Chart(document.getElementById('fgChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Fear & Greed',
            data: scores,
            borderColor: '#f97316',
            backgroundColor: 'rgba(249,115,22,0.06)',
            fill: true,
            tension: 0.4,
            pointBackgroundColor: colors,
            pointRadius: rows.length > 60 ? 0 : 4,
            pointHoverRadius: 6,
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            annotation: {
              annotations: {
                fear:  { type: 'line', yMin: 50, yMax: 50, borderColor: 'rgba(0,0,0,0.12)', borderWidth: 1, borderDash: [5,5] },
                greed: { type: 'line', yMin: 60, yMax: 60, borderColor: 'rgba(132,204,22,0.4)', borderWidth: 1, borderDash: [5,5] },
              }
            }
          },
          scales: {
            x: { ticks: { color: '#94a3b8', maxTicksLimit: 8, font: { size: 10 } }, grid: { color: 'rgba(0,0,0,0.04)' } },
            y: { min: 0, max: 100, ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: 'rgba(0,0,0,0.04)' } },
          }
        }
      });
    }

    // â”€â”€ å¸‚å ´ä¾¡æ ¼ã‚°ãƒ©ãƒ• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderMarketChart(rows) {
      const valid = rows.filter(r => r[C.SP500] && r[C.NASDAQ]);
      const labels = valid.map(r => r[C.DATE].split(' ')[0]);
      new Chart(document.getElementById('marketChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'S&P500',
              data: valid.map(r => num(r[C.SP500])),
              borderColor: '#2563eb',
              backgroundColor: 'rgba(37,99,235,0.05)',
              fill: true,
              tension: 0.4, pointRadius: valid.length > 60 ? 0 : 3, yAxisID: 'y1',
            },
            {
              label: 'NASDAQ',
              data: valid.map(r => num(r[C.NASDAQ])),
              borderColor: '#059669',
              backgroundColor: 'rgba(5,150,105,0.05)',
              fill: true,
              tension: 0.4, pointRadius: valid.length > 60 ? 0 : 3, yAxisID: 'y2',
            }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#64748b', font: { size: 11 }, boxWidth: 12 } } },
          scales: {
            x:  { ticks: { color: '#94a3b8', maxTicksLimit: 8, font: { size: 10 } }, grid: { color: 'rgba(0,0,0,0.04)' } },
            y1: { position: 'left',  ticks: { color: '#2563eb', font: { size: 10 }, callback: v => v.toLocaleString() }, grid: { color: 'rgba(0,0,0,0.04)' } },
            y2: { position: 'right', ticks: { color: '#059669', font: { size: 10 }, callback: v => v.toLocaleString() }, grid: { display: false } },
          }
        }
      });
    }

    // â”€â”€ åˆä½“ã‚°ãƒ©ãƒ• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderCombinedChart(rows) {
      const valid = rows.filter(r => r[C.SP500] && r[C.NASDAQ] && r[C.FG]);
      const labels  = valid.map(r => r[C.DATE].split(' ')[0]);
      const sp500   = valid.map(r => num(r[C.SP500]));
      const nasdaq  = valid.map(r => num(r[C.NASDAQ]));
      const fg      = valid.map(r => num(r[C.FG]));
      const fgColors = fg.map(s => fgColor(s ?? 50));

      new Chart(document.getElementById('combinedChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'S&P500',
              data: sp500,
              borderColor: '#2563eb',
              backgroundColor: 'rgba(37,99,235,0.04)',
              fill: true,
              tension: 0.4,
              pointRadius: valid.length > 60 ? 0 : 3,
              pointHoverRadius: 5,
              yAxisID: 'y1',
              order: 2,
            },
            {
              label: 'NASDAQ',
              data: nasdaq,
              borderColor: '#059669',
              backgroundColor: 'rgba(5,150,105,0.04)',
              fill: true,
              tension: 0.4,
              pointRadius: valid.length > 60 ? 0 : 3,
              pointHoverRadius: 5,
              yAxisID: 'y2',
              order: 3,
            },
            {
              label: 'Fear & Greed',
              data: fg,
              borderColor: '#f97316',
              backgroundColor: 'rgba(249,115,22,0.08)',
              fill: false,
              tension: 0.4,
              borderWidth: 2,
              pointBackgroundColor: fgColors,
              pointRadius: valid.length > 60 ? 0 : 3,
              pointHoverRadius: 5,
              yAxisID: 'y3',
              order: 1,
            },
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color: '#64748b', font: { size: 11 }, boxWidth: 12 } },
            annotation: {
              annotations: {
                fear:  { type: 'line', yScaleID: 'y3', yMin: 50, yMax: 50, borderColor: 'rgba(0,0,0,0.1)', borderWidth: 1, borderDash: [4,4] },
                greed: { type: 'line', yScaleID: 'y3', yMin: 60, yMax: 60, borderColor: 'rgba(132,204,22,0.3)', borderWidth: 1, borderDash: [4,4] },
              }
            }
          },
          scales: {
            x: {
              ticks: { color: '#94a3b8', maxTicksLimit: 8, font: { size: 10 } },
              grid: { color: 'rgba(0,0,0,0.04)' }
            },
            y1: {
              position: 'left',
              ticks: { color: '#2563eb', font: { size: 10 }, callback: v => v.toLocaleString() },
              grid: { color: 'rgba(0,0,0,0.04)' },
            },
            y2: {
              position: 'right',
              ticks: { color: '#059669', font: { size: 10 }, callback: v => v.toLocaleString() },
              grid: { display: false },
            },
            y3: {
              position: 'right',
              min: 0, max: 100,
              ticks: { color: '#f97316', font: { size: 10 } },
              grid: { display: false },
              offset: true,
            },
          }
        }
      });
    }

    // â”€â”€ ãƒ†ãƒ¼ãƒ–ãƒ«æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTable(rows) {
      const recent = [...rows].reverse().slice(0, 10);
      document.getElementById('tableBody').innerHTML = recent.map(r => {
        const score = num(r[C.FG]) ?? 0;
        const spInv = num(r[C.SP500_INV]);
        const ndInv = num(r[C.NASDAQ_INV]);
        return `<tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
          <td class="py-2 pr-3 text-slate-400 whitespace-nowrap">${r[C.DATE].split(' ')[0]}</td>
          <td class="py-2 pr-3 text-right font-bold whitespace-nowrap" style="color:${fgColor(score)}">${Math.round(score)}</td>
          <td class="py-2 pr-3 text-slate-600 whitespace-nowrap">${r[C.LABEL_EN] || 'â€”'}</td>
          <td class="py-2 pr-3 text-right text-cyan-500 whitespace-nowrap">${r[C.SKEW] || 'â€”'}</td>
          <td class="py-2 pr-3 text-right text-blue-600 whitespace-nowrap">${r[C.SP500] ? num(r[C.SP500])?.toLocaleString() : 'â€”'}</td>
          <td class="py-2 pr-3 text-right text-slate-600 whitespace-nowrap">${spInv !== null ? 'Â¥' + spInv.toLocaleString() : 'â€”'}</td>
          <td class="py-2 pr-3 text-right whitespace-nowrap ${pnlClass(r[C.SP500_PNL])}">${r[C.SP500_PNL] || 'â€”'}</td>
          <td class="py-2 pr-3 text-right text-emerald-600 whitespace-nowrap">${r[C.NASDAQ] ? num(r[C.NASDAQ])?.toLocaleString() : 'â€”'}</td>
          <td class="py-2 pr-3 text-right text-slate-600 whitespace-nowrap">${ndInv !== null ? 'Â¥' + ndInv.toLocaleString() : 'â€”'}</td>
          <td class="py-2 text-right whitespace-nowrap ${pnlClass(r[C.NASDAQ_PNL])}">${r[C.NASDAQ_PNL] || 'â€”'}</td>
        </tr>`;
      }).join('');
    }

    // â”€â”€ æ¥µåº¦ã®ææ€–ãƒ†ãƒ¼ãƒ–ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderFearTable(rows) {
      const fearRows = rows.filter(r => {
        const score = num(r[C.FG]);
        return score !== null && score <= 35;
      }).reverse(); // æ–°ã—ã„é †

      const tbody = document.getElementById('fearTableBody');
      const empty = document.getElementById('fearTableEmpty');

      if (fearRows.length === 0) {
        empty.classList.remove('hidden');
        return;
      }

      tbody.innerHTML = fearRows.map(r => {
        const score = num(r[C.FG]) ?? 0;
        const spInv = num(r[C.SP500_INV]);
        const ndInv = num(r[C.NASDAQ_INV]);
        return `<tr class="border-b border-slate-100 hover:bg-red-50 transition-colors">
          <td class="py-2 pr-3 text-slate-400 whitespace-nowrap">${r[C.DATE].split(' ')[0]}</td>
          <td class="py-2 pr-3 text-right font-bold whitespace-nowrap" style="color:${fgColor(score)}">${Math.round(score)}</td>
          <td class="py-2 pr-3 text-slate-600 whitespace-nowrap">${r[C.LABEL_EN] || 'â€”'}</td>
          <td class="py-2 pr-3 text-right text-cyan-500 whitespace-nowrap">${r[C.SKEW] || 'â€”'}</td>
          <td class="py-2 pr-3 text-right text-blue-600 whitespace-nowrap">${r[C.SP500] ? num(r[C.SP500])?.toLocaleString() : 'â€”'}</td>
          <td class="py-2 pr-3 text-right text-slate-600 whitespace-nowrap">${spInv !== null ? 'Â¥' + spInv.toLocaleString() : 'â€”'}</td>
          <td class="py-2 pr-3 text-right whitespace-nowrap ${pnlClass(r[C.SP500_PNL])}">${r[C.SP500_PNL] || 'â€”'}</td>
          <td class="py-2 pr-3 text-right text-emerald-600 whitespace-nowrap">${r[C.NASDAQ] ? num(r[C.NASDAQ])?.toLocaleString() : 'â€”'}</td>
          <td class="py-2 pr-3 text-right text-slate-600 whitespace-nowrap">${ndInv !== null ? 'Â¥' + ndInv.toLocaleString() : 'â€”'}</td>
          <td class="py-2 text-right whitespace-nowrap ${pnlClass(r[C.NASDAQ_PNL])}">${r[C.NASDAQ_PNL] || 'â€”'}</td>
        </tr>`;
      }).join('');
    }

    // â”€â”€ ãƒ¡ã‚¤ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function main() {
      try {
        const rows = await loadData();
        if (rows.length === 0) throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“');
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
        renderSummary(rows.at(-1));
        renderFGChart(rows);
        renderMarketChart(rows);
        renderCombinedChart(rows);
        renderTable(rows);
        renderFearTable(rows);
      } catch (e) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('errorMsg').textContent = e.message;
      }
    }
    // â”€â”€ Apple Touch Iconï¼ˆiOS ãƒ›ãƒ¼ãƒ ç”»é¢ã‚¢ã‚¤ã‚³ãƒ³ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setAppleTouchIcon() {
      const size = 180;
      const canvas = document.createElement('canvas');
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');

      // è§’ä¸¸ã®é’èƒŒæ™¯
      const r = 40;
      ctx.fillStyle = '#2563eb';
      ctx.beginPath();
      ctx.moveTo(r, 0);
      ctx.lineTo(size - r, 0);
      ctx.quadraticCurveTo(size, 0, size, r);
      ctx.lineTo(size, size - r);
      ctx.quadraticCurveTo(size, size, size - r, size);
      ctx.lineTo(r, size);
      ctx.quadraticCurveTo(0, size, 0, size - r);
      ctx.lineTo(0, r);
      ctx.quadraticCurveTo(0, 0, r, 0);
      ctx.closePath();
      ctx.fill();

      // ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ï¼ˆç™½ï¼‰
      // å…ƒã®SVGåº§æ¨™ (32x32) ã‚’ 180x180 ã«ã‚¹ã‚±ãƒ¼ãƒ«
      const s = size / 32;
      const pts = [[3,24],[9,14],[14,18],[22,8],[29,12]];
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 13;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();
      ctx.moveTo(pts[0][0] * s, pts[0][1] * s);
      for (let i = 1; i < pts.length; i++) {
        ctx.lineTo(pts[i][0] * s, pts[i][1] * s);
      }
      ctx.stroke();

      const link = document.createElement('link');
      link.rel = 'apple-touch-icon';
      link.href = canvas.toDataURL('image/png');
      document.head.appendChild(link);
    }
    setAppleTouchIcon();

    main();
  </script>
</body>
</html>
